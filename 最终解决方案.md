# QQ 机器人回调验证 - 最终解决方案

## 🔍 问题根因

n8n 的 webhook 通过 API 创建后，**需要手动在编辑器中执行一次**才能注册到生产环境。这就是为什么 webhook 返回 404。

---

## ✅ 解决方案

### 方法 A：在 n8n 中手动执行（推荐）

1. **登录 n8n**: https://n8n.meowlove.cn

2. **打开工作流**: 找到 "QQ Bot Callback Simple" 并点击编辑

3. **点击 "Execute Workflow" 按钮**:
   - 在画布上方有一个 **"Execute Workflow"** 按钮
   - 点击它，这会触发一次 test 执行
   - 这次执行会注册 webhook 到生产环境

4. **等待几秒钟**，让 webhook 完全注册

5. **测试 webhook**:
   ```bash
   curl -X POST "https://n8n.meowlove.cn/webhook/qq-bot-callback" \
     -H "Content-Type: application/json" \
     -d '{"op":13,"d":{"plain_token":"test","event_ts":"123456"}}'
   ```

6. **如果返回 JSON（不是 404），说明成功了！**

7. **在 QQ 平台填写回调地址**:
   ```
   https://n8n.meowlove.cn/webhook/qq-bot-callback
   ```

---

### 方法 B：使用 n8n REST API 触发执行（需要登录凭证）

如果手动执行不方便，也可以调用 n8n 的执行 API 来注册 webhook：

```bash
# 这个 API 需要登录后的 session ID
curl -X POST "https://n8n.meowlove.cn/rest/workflows/6J7GsJv1Jl9OwWXe/execute" \
  -H "Content-Type: application/json" \
  -d '{"data":{}}'
```

但这个方法需要您登录 n8n 后获取 cookie。

---

## 📋 完整的 Ed25519 签名工作流

上面创建的测试工作流使用的是假签名。要真正通过 QQ 验证，需要使用 Ed25519 算法。

### 为什么之前的工作流不工作？

1. **n8n Function 节点** 不支持 `require('tweetnacl')` - 外部库不可用
2. **n8n Code 节点** 也可能没有安装 tweetnacl

### 真正的解决方案

您需要在 n8n 服务器上安装 Ed25519 库：

```bash
# SSH 到您的 NAS
cd /path/to/n8n
npm install tweetnacl tweetnacl-util
# 重启 n8n
```

然后使用 Code 节点而不是 Function 节点。

---

## 🚀 当前最快的解决方案

1. **先使用测试工作流**，确认 webhook 能被 QQ 平台访问
2. **确认网络连接正常**
3. **然后解决 Ed25519 签名问题**

### 第一步：手动执行工作流注册 webhook

在 n8n 中：
- 打开 "QQ Bot Callback Simple" 工作流
- 点击 "Execute Workflow" 按钮
- 等待几秒

### 第二步：测试 webhook

```bash
curl -X POST "https://n8n.meowlove.cn/webhook/qq-bot-callback" \
  -H "Content-Type: application/json" \
  -d '{"op":13,"d":{"plain_token":"test123","event_ts":"123456"}}'
```

### 第三步：在 QQ 平台测试

如果第二步返回 JSON（不是 404），在 QQ 平台填写回调地址测试。

---

## ❓ 如果还是 404

说明 webhook 没有正确注册。可能的原因：

1. **工作流没有真正激活** - 在 n8n UI 中检查是否显示绿色 Active
2. **Webhook 路径冲突** - 可能有其他工作流使用了相同路径
3. **n8n 配置问题** - 检查 n8n 的环境变量配置

---

## 📞 需要帮助

请提供以下信息：

1. **n8n 中工作流列表的截图** - 确认工作流状态
2. **点击 "Execute Workflow" 后的截图** - 确认执行成功
3. **curl 测试的结果** - 确认 webhook 可访问

这样我可以更准确地帮您诊断问题！
