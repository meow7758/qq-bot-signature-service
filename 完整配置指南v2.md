# QQ 机器人 + Wallabag 完整配置指南 v2

## ⚠️ 重要：必须先完成 IP 白名单配置

### 第一步：配置 IP 白名单（必须！）

您的 QQ 机器人已启用 IP 白名单功能，**必须先配置**，否则回调会失败！

1. 登录 [QQ 机器人开放平台](https://bot.q.qq.com)
2. 进入您的机器人管理页面（AppID: 102838256）
3. 找到 **「IP 白名单配置」**
4. 填入：`123.146.206.74`
5. 保存

---

## 📥 第二步：导入新版工作流

1. 登录 n8n：https://n8n.meowlove.cn

2. 点击右上角的 **「...」** → **「Import from File」**

3. 选择文件：
   ```
   C:\Users\Administrator\.craft-agent\workspaces\my-workspace\sessions\260206-fit-wolf\qq-bot-wallabag-v2.json
   ```

4. 点击 **「Import」** 导入

---

## 🔧 第三步：激活工作流

1. 点击工作流右上角的 **「Inactive」** 开关，变为 **「Active」**

2. 看到 **「Production」** 标签变为绿色

---

## 🎯 第四步：配置 QQ 机器人回调地址

### 登录 QQ 机器人开放平台

1. 访问：https://bot.q.qq.com

2. 进入您的机器人管理页面（AppID: 102838256）

### 配置事件推送

在 **「开发设置」** → **「事件推送」** 中配置：

| 配置项 | 值 |
|--------|-----|
| **回调地址** | `https://n8n.meowlove.cn/webhook/qq-bot-wallabag` |

> 💡 **注意**：新版工作流使用 Ed25519 签名算法，无需配置 Token！

---

## ✅ 配置完成后的测试

在 QQ 中向机器人发送消息：

### 保存文章
```
https://example.com/article
```

### 搜索文章
```
搜索 人工智能
```

---

## 📊 技术说明

### QQ 机器人签名算法

QQ 机器人平台使用 **Ed25519 签名算法**进行验证：

1. **回调地址验证**（OpCode 13）
   - QQ 平台发送 `plain_token` 和 `event_ts`
   - 服务端使用 Bot Secret 生成 Ed25519 签名
   - 返回 `plain_token` 和 `signature`

2. **事件签名验证**（OpCode 0）
   - QQ 平台在 HTTP Header 中发送签名：
     - `X-Signature-Ed25519`: Ed25519 签名（64字节十六进制）
     - `X-Signature-Timestamp`: 签名时间戳
   - 服务端验证签名有效性

### IP 白名单要求

QQ 机器人平台要求配置服务器的公网 IP 地址，只有白名单内的 IP 才能接收事件推送。

---

## 🔍 工作流节点说明

| 节点名称 | 功能 |
|----------|------|
| **QQ Bot Webhook** | 接收 QQ 机器人事件推送 |
| **Verify and Parse** | 处理回调验证和事件签名 |
| **Check Result** | 检查验证结果 |
| **Parse Event** | 解析事件类型（私聊/群聊） |
| **Route Intent** | 路由到不同处理逻辑 |
| **Parse Command** | 解析用户命令（保存/搜索） |
| **Save to Wallabag** | 保存到 Wallabag |
| **Respond Success** | 返回成功响应 |

---

## ❓ 常见问题

### Q1: 回调地址验证失败？
**A**:
1. 确认 IP 白名单已配置：`123.146.206.74`
2. 确认工作流已激活（Active 状态）
3. 查看 n8n 执行日志是否有错误

### Q2: 收不到 QQ 消息？
**A**:
1. 确认机器人已添加到群聊或私聊
2. 确认事件订阅已开启（C2C_MESSAGE_CREATE、GROUP_AT_MESSAGE_CREATE）
3. 确认机器人有接收消息的权限

### Q3: Ed25519 签名验证失败？
**A**: 新版工作流已集成签名验证逻辑，无需手动配置。如仍有问题，请检查 n8n 执行日志。

---

## 📞 获取帮助

如遇问题，请检查：
1. IP 白名单是否正确配置
2. n8n 工作流是否已激活
3. QQ 机器人权限是否正确
4. n8n 执行日志中的错误信息
